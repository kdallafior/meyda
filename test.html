<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Meyda Test Visualizer</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r74/three.js" charset="utf-8"></script>
  <script type="text/javascript" src="meyda.js"></script>
</head>
<body style="margin:0px;">
  <script>
  //console.log("hello")
  var context = new AudioContext();

  var meyda = null;
  navigator.getUserMedia = navigator.webkitGetUserMedia || navigator.getUserMedia;
  navigator.getUserMedia(
    //constraints
    {
      video: false, audio: true
    },
    //success
    function(mediaStream) {
      console.log("Success!")
      source = context.createMediaStreamSource(mediaStream);
      // instantiate new meyda
      meyda = Meyda.createMeydaAnalyzer({
      	audioContext:context,
      	source:source,
      	bufferSize:256
      });
      render();
    },
    //error
    function(err) {
      console.log("Error: ", err  );
      alert("There has been an error accessing the microphone.");
    }
  )

  var resolution = 720;
  var aspectRatio = 16/10;
  var scene = new THREE.Scene();
  var camera = new THREE.PerspectiveCamera( 40, aspectRatio, 0.1, 1000 );

  var initializeFFTs = function(number,pointCount){
    var ffts = [];
    for(var i = 0; i < number; i++){
      ffts.push(Array.apply(null, Array(pointCount)).map(Number.prototype.valueOf,0));
    }
    return ffts;
  }

  var material = new THREE.LineBasicMaterial({
    color: 0x00ff00
  });

  var ffts = initializeFFTs(20, 128);

  var renderer = new THREE.WebGLRenderer();
  renderer.setSize( resolution*aspectRatio, resolution );
  document.body.appendChild( renderer.domElement );

  var light = new THREE.AmbientLight( 0x404040 ); // soft white light
  scene.add( light );

  var directionalLight = new THREE.DirectionalLight( 0xffffff, 0.5 );
  directionalLight.position.set( 0, 1, 1 );
  scene.add( directionalLight );

  camera.position.z = 5;

  // Unchanging variables
  var meydaCheck = (meyda !== null); // Moved this out of render loop
  var spectralCentroid = null;
  var length = 1;
  var hex = 0xffff00;
  var dir = new THREE.Vector3( 0, 1, 0 );
  var origin = new THREE.Vector3(1, -6, -15);

  // Variables we update
  var arrowHelper = new THREE.ArrowHelper( dir, origin, length, hex );
  var lines = new THREE.Group(); // Lets create a seperate group for our lines
  scene.add( arrowHelper );
  scene.add( lines );

  function render() {
    requestAnimationFrame( render );
    renderer.render( scene, camera );

    for (var c = 0; c < lines.children.length; c++) { // I feel like there is a faster way to do this?
        lines.remove(lines.children[c]); //forEach is slow
    }

    ffts.pop(); // If we call render in the success call back then we don't need to check every frame
    ffts.unshift(meyda.get('amplitudeSpectrum'));
    spectralCentroid = meyda.get('spectralCentroid');

    for(var i = 0; i < ffts.length; i++){
      if(ffts[i]){
        var fftslen = ffts[i].length
        var geometry = new THREE.Geometry(); // May be a way to reuse this
        if (fftslen) {
          for(var j = 0; j < fftslen; j++){
            geometry.vertices.push(new THREE.Vector3(-11+(22*j/fftslen),-5+ffts[i][j],-15-i));
          }
        }
        lines.add( new THREE.Line(geometry, material) );
        geometry.dispose();
      }
      if(spectralCentroid && fftslen){ // SpectralCentroid is an awesome variable name
        arrowHelper.position.set(-11+(22*spectralCentroid/fftslen), -6, -15); // We're really just updating the x axis
      }
    }
  }

  </script>
</body>
</html>
